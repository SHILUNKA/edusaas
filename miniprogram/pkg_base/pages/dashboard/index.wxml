<wxs module="utils" src="./utils.wxs"></wxs>

<view class="dashboard-container" style="padding-bottom: 200rpx;">
  <!-- åº•éƒ¨å¯¼èˆª -->
  <dynamic-tab-bar selected="{{0}}"></dynamic-tab-bar>
  
  <!-- å¤´éƒ¨ä¿¡æ¯ -->
  <view class="header">
    <view class="base-info">
      <text class="base-name">{{baseName}}</text>
      <text class="update-time">{{updateTime}}</text>
    </view>
    <view class="refresh-btn" bindtap="onRefresh">
      <text class="icon">â†»</text>
    </view>
  </view>

  <!-- ç°é‡‘æµè­¦æŠ¥ï¼ˆå¦‚æœæœ‰å¼‚å¸¸ï¼‰ -->
  <view class="alert-banner critical" wx:if="{{metrics.cash_flow.status === 'critical'}}">
    <text class="alert-icon">ğŸ”´</text>
    <view class="alert-content">
      <text class="alert-title">ç°é‡‘æµå‘Šæ€¥</text>
      <text class="alert-desc">å¯ç”¨èµ„é‡‘ä»…å¤Ÿ{{utils.formatDecimal(metrics.cash_flow.runway_months, 1)}}ä¸ªæœˆ</text>
    </view>
  </view>

  <view class="alert-banner warning" wx:if="{{metrics.cash_flow.status === 'warning'}}">
    <text class="alert-icon">ğŸŸ¡</text>
    <view class="alert-content">
      <text class="alert-title">ç°é‡‘æµé¢„è­¦</text>
      <text class="alert-desc">åº”æ”¶æ¬¾é€¾æœŸ: {{metrics.cash_flow.overdue_count}}äºº Â¥{{utils.formatMoney(metrics.cash_flow.accounts_receivable)}}</text>
    </view>
  </view>

  <!-- æŒ‡æ ‡1: ç°é‡‘æµå¥åº·åº¦ -->
  <view class="metric-card priority">
    <view class="card-header">
      <text class="card-title">ğŸ’µ ç°é‡‘æµå¥åº·åº¦</text>
      <text class="status-badge status-{{metrics.cash_flow.status}}">
        {{metrics.cash_flow.status === 'healthy' ? 'å¥åº·' : metrics.cash_flow.status === 'warning' ? 'é¢„è­¦' : 'å‘Šæ€¥'}}
      </text>
    </view>
    <view class="card-body">
      <view class="metric-row">
        <text class="label">å¯ç”¨èµ„é‡‘</text>
        <text class="value big">Â¥{{utils.formatMoneyK(metrics.cash_flow.available_funds)}}</text>
      </view>
      <view class="metric-row">
        <text class="label">åº”æ”¶é€¾æœŸ</text>
        <text class="value {{metrics.cash_flow.overdue_count > 0 ? 'danger' : ''}}">
          Â¥{{utils.formatMoneyK(metrics.cash_flow.accounts_receivable)}} ({{metrics.cash_flow.overdue_count}}äºº)
        </text>
      </view>
      <view class="metric-row">
        <text class="label">èµ„é‡‘å¯ç”¨</text>
        <text class="value">{{utils.formatDecimal(metrics.cash_flow.runway_months, 1)}}ä¸ªæœˆ</text>
      </view>
    </view>
  </view>

  <!-- æŒ‡æ ‡2: ä»Šæ—¥æ”¶æ¬¾ -->
  <view class="metric-card">
    <view class="card-header">
      <text class="card-title">ğŸ’° ä»Šæ—¥æ”¶æ¬¾</text>
      <text class="card-subtitle">{{metrics.today_revenue.order_count}}ç¬”è®¢å•</text>
    </view>
    <view class="card-body">
      <text class="big-number">Â¥{{utils.formatMoney(metrics.today_revenue.total)}}</text>
      <view class="split-bar">
        <view class="split-item">
          <text class="split-label">ToC</text>
          <text class="split-value">Â¥{{utils.formatMoney(metrics.today_revenue.toc)}}</text>
        </view>
        <view class="split-divider"></view>
        <view class="split-item">
          <text class="split-label">ToB</text>
          <text class="split-value">Â¥{{utils.formatMoney(metrics.today_revenue.tob)}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æŒ‡æ ‡3 & 4: å­¦å‘˜æ•° & æ‹›ç”Ÿæ•ˆç‡ -->
  <view class="metric-row-group">
    <!-- å­¦å‘˜æ•° -->
    <view class="metric-card half">
      <view class="card-header">
        <text class="card-title">ğŸ‘¥ å­¦å‘˜æ•°</text>
      </view>
      <view class="card-body">
        <text class="big-number">{{metrics.students.active_students}}</text>
        <text class="small-text">/ {{metrics.students.capacity}} ({{utils.formatPercent(metrics.students.utilization_rate)}}%)</text>
        <view class="metric-row mini">
          <text class="label">æœ¬æœˆ</text>
          <text class="value">
            <text class="success">+{{metrics.students.this_month_new}}</text>
            <text class="danger"> -{{metrics.students.this_month_churned}}</text>
          </text>
        </view>
      </view>
    </view>

    <!-- æ‹›ç”Ÿæ•ˆç‡ -->
    <view class="metric-card half">
      <view class="card-header">
        <text class="card-title">ğŸ“ˆ æ‹›ç”Ÿæ•ˆç‡</text>
      </view>
      <view class="card-body">
        <text class="big-number">{{utils.formatPercent(metrics.recruitment.trial_conversion_rate)}}%</text>
        <text class="small-text">è¯•å¬è½¬åŒ–ç‡</text>
        <view class="metric-row mini">
          <text class="label">LTV/CAC</text>
          <text class="value success">{{utils.formatDecimal(metrics.recruitment.ltv_cac_ratio, 1)}}å€</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æŒ‡æ ‡5: è¥æ”¶è¿›åº¦ -->
  <view class="metric-card">
    <view class="card-header">
      <text class="card-title">ğŸ“Š æœ¬æœˆè¥æ”¶è¿›åº¦</text>
      <text class="status-badge status-{{metrics.revenue_progress.pace_status}}">
        {{metrics.revenue_progress.pace_status === 'ahead' ? 'è¶…å‰' : 
          metrics.revenue_progress.pace_status === 'on_track' ? 'æ­£å¸¸' : 'è½å'}}
      </text>
    </view>
    <view class="card-body">
      <view class="progress-info">
        <text class="progress-label">ç›®æ ‡ Â¥{{utils.formatMoney(metrics.revenue_progress.target)}}</text>
        <text class="progress-value">å®é™… Â¥{{utils.formatMoney(metrics.revenue_progress.actual)}}</text>
      </view>
      <view class="progress-bar-container">
        <view class="progress-bar" style="width: {{utils.formatPercent(metrics.revenue_progress.completion_rate)}}%"></view>
      </view>
      <text class="progress-percent">{{utils.formatDecimal(metrics.revenue_progress.completion_rate * 100, 1)}}%</text>
    </view>
  </view>

  <!-- æŒ‡æ ‡6: åˆ©æ¶¦å¥åº·åº¦ -->
  <view class="metric-card">
    <view class="card-header">
      <text class="card-title">ğŸ’° åˆ©æ¶¦å¥åº·åº¦</text>
      <text class="status-badge status-{{metrics.profitability.profit_status}}">
        {{metrics.profitability.profit_status === 'healthy' ? 'ä¼˜ç§€' : 
          metrics.profitability.profit_status === 'warning' ? 'ä¸€èˆ¬' : 'åä½'}}
      </text>
    </view>
    <view class="card-body">
      <view class="metric-row">
        <text class="label">æ¯›åˆ©ç‡</text>
        <text class="value big">{{utils.formatPercent(metrics.profitability.gross_margin)}}%</text>
      </view>
      <view class="metric-row">
        <text class="label">ToBå æ¯”</text>
        <text class="value">
          {{utils.formatPercent(metrics.profitability.tob_ratio)}}% 
          <text class="small-text">/ ç›®æ ‡{{utils.formatPercent(metrics.profitability.tob_target)}}%</text>
        </text>
      </view>
    </view>
  </view>

  <!-- æŒ‡æ ‡7: ToBè®¢å•çŠ¶æ€ -->
  <view class="metric-card">
    <view class="card-header">
      <text class="card-title">ğŸ¢ ToBè®¢å•çŠ¶æ€</text>
    </view>
    <view class="card-body">
      <view class="metric-row" wx:if="{{metrics.tob_status.tomorrow_events_count > 0}}">
        <text class="label highlight">æ˜æ—¥æ´»åŠ¨</text>
        <text class="value highlight">{{metrics.tob_status.tomorrow_events_count}}åœº</text>
      </view>
      <view class="metric-row">
        <text class="label">æ‰§è¡Œä¸­</text>
        <text class="value">{{metrics.tob_status.in_progress_count}}ä¸ª 
          <text class="small-text">Â¥{{utils.formatMoney(metrics.tob_status.in_progress_amount)}}</text>
        </text>
      </view>
      <view class="metric-row" wx:if="{{metrics.tob_status.overdue_count > 0}}">
        <text class="label">å»¶æœŸ</text>
        <text class="value danger">{{metrics.tob_status.overdue_count}}ä¸ª</text>
      </view>
    </view>
  </view>

  <!-- æŒ‡æ ‡8: å¼‚å¸¸é¢„è­¦ -->
  <view class="metric-card alert-card" wx:if="{{hasAlerts}}">
    <view class="card-header">
      <text class="card-title">âš ï¸ éœ€è¦å…³æ³¨</text>
    </view>
    <view class="card-body">
      <view class="alert-list">
        <view class="alert-item critical" wx:for="{{metrics.alerts.critical}}" wx:key="index">
          <text class="alert-dot">ğŸ”´</text>
          <text class="alert-text">{{item.message}}</text>
        </view>
        <view class="alert-item warning" wx:for="{{metrics.alerts.warning}}" wx:key="index">
          <text class="alert-dot">ğŸŸ¡</text>
          <text class="alert-text">{{item.message}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view class="loading-mask" wx:if="{{loading}}">
    <view class="loading-content">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </view>

</view>
