<view class="container" wx:if="{{!loading && lead}}">
  
  <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
  <view class="info-card">
    <view class="status-badge">{{getStatusText(lead.status)}}</view>
    
    <view class="contact-info">
      <text class="name">{{lead.contact_name}}</text>
      <view class="phone-row">
        <text class="phone">{{lead.phone_number}}</text>
        <button class="call-btn" size="mini" bindtap="onCall">
          ğŸ“ æ‹¨æ‰“
        </button>
      </view>
    </view>

    <view class="quality-score" wx:if="{{lead.quality_score}}">
      <text class="label">è´¨é‡è¯„åˆ†ï¼š</text>
      <text class="stars">
        <text wx:for="{{[1,2,3,4,5]}}" wx:key="item">
          {{item <= lead.quality_score ? 'â˜…' : 'â˜†'}}
        </text>
      </text>
    </view>

    <view class="detail-row" wx:if="{{lead.child_name}}">
      <text class="label">å­©å­ï¼š</text>
      <text>{{lead.child_name}}</text>
      <text wx:if="{{lead.child_age}}">ï¼ˆ{{lead.child_age}}å²ï¼‰</text>
    </view>

    <view class="detail-row" wx:if="{{lead.child_grade}}">
      <text class="label">å¹´çº§ï¼š</text>
      <text>{{lead.child_grade}}</text>
    </view>

    <view class="detail-row" wx:if="{{lead.source}}">
      <text class="label">æ¥æºï¼š</text>
      <text>{{lead.source}}</text>
    </view>

    <view class="detail-row" wx:if="{{lead.wechat_id}}">
      <text class="label">å¾®ä¿¡ï¼š</text>
      <text>{{lead.wechat_id}}</text>
    </view>

    <view class="detail-row" wx:if="{{lead.assigned_to_name}}">
      <text class="label">è´Ÿè´£äººï¼š</text>
      <text>{{lead.assigned_to_name}}</text>
    </view>

    <view class="detail-row" wx:if="{{lead.next_follow_up_at}}">
      <text class="label">ä¸‹æ¬¡è·Ÿè¿›ï¼š</text>
      <text class="highlight">{{formatDateTime(lead.next_follow_up_at)}}</text>
    </view>

    <view class="notes" wx:if="{{lead.notes}}">
      <text class="label">å¤‡æ³¨ï¼š</text>
      <text>{{lead.notes}}</text>
    </view>
  </view>

  <!-- è·Ÿè¿›è®°å½• -->
  <view class="follow-up-section">
    <view class="section-title">è·Ÿè¿›è®°å½•</view>

    <view class="timeline" wx:if="{{lead.follow_up_records && lead.follow_up_records.length > 0}}">
      <view 
        class="timeline-item" 
        wx:for="{{lead.follow_up_records}}" 
        wx:key="id"
      >
        <view class="timeline-dot"></view>
        <view class="timeline-content">
          <view class="item-header">
            <view class="type-badge">{{item.follow_up_type}}</view>
            <view class="outcome" wx:if="{{item.outcome}}">
              {{getOutcomeIcon(item.outcome)}}
            </view>
          </view>
          <view class="content">{{item.content}}</view>
          <view class="footer">
            <text class="author">{{item.created_by_name}}</text>
            <text class="time">{{formatDateTime(item.created_at)}}</text>
          </view>
        </view>
      </view>
    </view>

    <view class="empty-timeline" wx:else>
      <text>æš‚æ— è·Ÿè¿›è®°å½•</text>
    </view>
  </view>

  <!-- æ·»åŠ è·Ÿè¿›æŒ‰é’® -->
  <view class="action-btn" bindtap="onAddFollowUp">
    <text class="icon">+</text>
    <text>æ·»åŠ è·Ÿè¿›</text>
  </view>

</view>

<!-- åŠ è½½ä¸­ -->
<view class="loading" wx:if="{{loading}}">
  <text>åŠ è½½ä¸­...</text>
</view>

<!-- è·Ÿè¿›å¯¹è¯æ¡† -->
<view class="dialog-mask" wx:if="{{showFollowUpDialog}}" catchtap="onCloseFollowUpDialog">
  <view class="dialog" catchtap="">
    <view class="dialog-title">æ·»åŠ è·Ÿè¿›è®°å½•</view>
    
    <view class="dialog-content">
      <view class="form-item">
        <text class="label">è·Ÿè¿›æ–¹å¼</text>
        <picker 
          mode="selector" 
          range="{{typeOptions}}"
          range-key="label"
          bindchange="onTypeChange"
        >
          <view class="picker">
            {{typeOptions[0].label}}
          </view>
        </picker>
      </view>

      <view class="form-item">
        <text class="label">è·Ÿè¿›å†…å®¹</text>
        <textarea 
          class="textarea" 
          placeholder="è¯·è¾“å…¥è·Ÿè¿›å†…å®¹"
          value="{{followUpForm.content}}"
          bindinput="onFollowUpInput"
          data-field="content"
          maxlength="500"
        />
      </view>

      <view class="form-item">
        <text class="label">è·Ÿè¿›ç»“æœ</text>
        <picker 
          mode="selector" 
          range="{{outcomeOptions}}"
          range-key="label"
          bindchange="onOutcomeChange"
        >
          <view class="picker">
            {{outcomeOptions[0].label}}
          </view>
        </picker>
      </view>

      <view class="form-item">
        <text class="label">ä¸‹æ¬¡è·Ÿè¿›æ—¶é—´</text>
        <picker 
          mode="date" 
          bindchange="onDateChange"
        >
          <view class="picker">
            {{followUpForm.next_follow_up_at || 'é€‰æ‹©æ—¥æœŸ'}}
          </view>
        </picker>
      </view>
    </view>

    <view class="dialog-actions">
      <button class="cancel-btn" bindtap="onCloseFollowUpDialog">å–æ¶ˆ</button>
      <button class="confirm-btn" bindtap="onSubmitFollowUp">ç¡®å®š</button>
    </view>
  </view>
</view>
