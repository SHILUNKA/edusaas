<wxs module="utils">
  module.exports.formatNumber = function(n) {
    if (n >= 10000) return (n/10000).toFixed(1) + 'w';
    return n;
  }
</wxs>
<view class="container">
  <!-- Tabs -->
  <view class="tabs">
    <view class="tab {{currentTab === 'revenue' ? 'active' : ''}}" bindtap="switchTab" data-tab="revenue">ğŸ’° è¥æ”¶</view>
    <view class="tab {{currentTab === 'sales' ? 'active' : ''}}" bindtap="switchTab" data-tab="sales">ğŸ† é”€å”®</view>
    <view class="tab {{currentTab === 'funnel' ? 'active' : ''}}" bindtap="switchTab" data-tab="funnel">ğŸ¯ è½¬åŒ–</view>
    <view class="tab {{currentTab === 'course' ? 'active' : ''}}" bindtap="switchTab" data-tab="course">ğŸ”¥ è¯¾ç¨‹</view>
  </view>

  <!-- Content -->
  <view class="content" wx:if="{{chartData}}">
    
    <!-- Summary Card -->
    <view class="summary-card" wx:if="{{chartData.summary}}">
        <view class="msg-wrap">
            <text class="msg-icon">ğŸ’¡</text>
            <text class="msg">{{chartData.summary.msg || 'æ•°æ®æ´å¯Ÿ'}}</text>
        </view>
        <view class="metrics">
            <text class="trend" wx:if="{{chartData.summary.trend}}">ğŸ“ˆ {{chartData.summary.trend}}</text>
            <text class="rate" wx:if="{{chartData.summary.conversion_rate}}">è½¬åŒ–ç‡: {{chartData.summary.conversion_rate}}</text>
            <text class="top" wx:if="{{chartData.summary.top_sales}}">é”€å† : {{chartData.summary.top_sales}}</text>
        </view>
    </view>

    <!-- Chart Area -->
    <view class="chart-container">
      <view class="chart-header">
         <text class="chart-title">{{chartData.datasets[0].label}}åˆ†å¸ƒ</text>
      </view>
      
      <!-- Horizontal Bars (Ranking for Sales, Course) -->
      <view class="bar-chart-h" wx:if="{{currentTab === 'sales' || currentTab === 'course'}}">
         <block wx:for="{{chartData.labels}}" wx:key="*this">
            <view class="bar-row">
                <view class="row-label">{{item}}</view>
                <view class="bar-track">
                    <view class="bar-fill {{index < 3 ? 'top3' : ''}}" style="width: {{chartData.datasets[0].data[index] / maxData * 100}}%"></view>
                </view>
                <view class="row-value">{{utils.formatNumber(chartData.datasets[0].data[index])}}</view>
            </view>
         </block>
      </view>

      <!-- Vertical Bars (Trend for Revenue, Funnel) -->
      <view class="bar-chart-v" wx:if="{{currentTab === 'revenue' || currentTab === 'funnel'}}">
         <view class="bars-wrap">
             <view class="bar-col" wx:for="{{chartData.labels}}" wx:key="*this">
                <view class="bar-value-top">{{utils.formatNumber(chartData.datasets[0].data[index])}}</view>
                <view class="bar-track-v">
                    <view class="bar-fill-v" style="height: {{chartData.datasets[0].data[index] / maxData * 100}}%"></view>
                </view>
                <view class="col-label">{{item}}</view>
             </view>
         </view>
      </view>

    </view>
    
    <!-- Explanation -->
    <view class="footer-tip">
        * æ•°æ®æ›´æ–°äº {{updatedTime}}
    </view>

  </view>

  <view class="loading-wrap" wx:else>
    <view class="loading-spinner"></view>
    <text>æ•°æ®åŠ è½½ä¸­...</text>
  </view>
</view>
