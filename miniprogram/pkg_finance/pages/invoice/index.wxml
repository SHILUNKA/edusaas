<view class="page">
  <view class="tabs">
    <view class="tab-item {{activeTab === 0 ? 'active' : ''}}" bindtap="switchTab" data-idx="{{0}}">待开票</view>
    <view class="tab-item {{activeTab === 1 ? 'active' : ''}}" bindtap="switchTab" data-idx="{{1}}">已开票</view>
  </view>

  <view class="list-container">
    <block wx:if="{{list.length > 0}}">
      <view class="order-card" wx:for="{{list}}" wx:key="id">
        <view class="card-header">
          <text class="order-no">订单号: {{item.order_no}}</text>
          <text class="pay-status {{item.paidStatusClass}}">{{item.payment_status_text}}</text>
        </view>
        <view class="card-body">
          <view class="info-row">
            <text class="label">客户名称</text>
            <text class="val">{{item.customer_name || '-'}} ({{item.contact_name}})</text>
          </view>
          <view class="info-row">
            <text class="label">订单金额</text>
            <text class="val price">¥{{item.total_amount_fmt}}</text>
          </view>
          <view class="info-row" wx:if="{{activeTab === 1}}">
             <text class="label">发票号码</text>
             <text class="val">{{item.invoice_no || '-'}}</text>
          </view>
        </view>
        <view class="card-footer">
          <block wx:if="{{activeTab === 0}}">
             <button class="btn-issue" bindtap="openIssueModal" data-item="{{item}}">录入发票</button>
          </block>
          <block wx:else>
             <view class="issued-tag">已开票</view>
             <button wx:if="{{item.invoice_url}}" class="btn-view" bindtap="previewInvoice" data-url="{{item.invoice_url}}">查看附件</button>
          </block>
        </view>
      </view>
    </block>
    <view class="empty-state" wx:else>暂无订单数据</view>
  </view>

  <!-- 录入发票弹窗 -->
  <view class="modal-mask" wx:if="{{showModal}}" bindtap="closeModal"></view>
  <view class="modal-box" wx:if="{{showModal}}">
    <view class="modal-header">录入发票信息</view>
    <view class="modal-content">
       <view class="input-group">
         <view class="input-label">发票号码</view>
         <input class="input-control" placeholder="请输入纸质/电子发票号" model:value="{{formInvoiceNo}}" />
       </view>
       <view class="input-group">
         <view class="input-label">发票凭证</view>
         <view class="upload-trigger" bindtap="chooseInvoiceImg">
            <image wx:if="{{formTempFilePath}}" src="{{formTempFilePath}}" mode="aspectFit" class="preview" />
            <view wx:else class="placeholder">
               <text class="plus">+</text>
               <text>上传图片</text>
            </view>
         </view>
       </view>
    </view>
    <view class="modal-btns">
       <button class="btn-cancel" bindtap="closeModal">取消</button>
       <button class="btn-confirm" bindtap="submitInvoice" loading="{{submitting}}">确认开票</button>
    </view>
  </view>
</view>
