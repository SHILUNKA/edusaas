<view class="container">
  <!-- 1. æ ¸å¿ƒæ•°æ®é©¾é©¶èˆ± (Dark Theme) -->
  <view class="cockpit-card">
    <view class="cockpit-header">
      <text class="cockpit-title">è´¢åŠ¡é©¾é©¶èˆ±</text>
      <view class="date-badge">{{currentDate}}</view>
    </view>
    
    <!-- æ ¸å¿ƒæŒ‡æ ‡: é¢„å……æ±  & ç°é‡‘æµ -->
    <view class="main-metrics">
      <view class="metric-block warning">
        <view class="label">
          æ€»é¢„å……æ±  (è´Ÿå€º)
          <icon type="warn" size="12" color="#FF4D4F" />
        </view>
        <view class="value-row">
          <text class="currency">Â¥</text>
          <text class="amount-lg">{{stats.total_prepaid_pool_fmt || '0'}}</text>
        </view>
        <view class="trend-row down">
           <text>æ¶ˆè¯¾ç‡ 45%</text> <!-- Mock data for now -->
        </view>
      </view>

      <view class="metrics-divider"></view>

      <view class="metric-block">
        <view class="label">æœ¬æœˆç°é‡‘æµ (Cash In)</view>
        <view class="value-row">
          <text class="currency">Â¥</text>
          <text class="amount-lg">{{stats.month_cash_in_fmt || '0'}}</text>
        </view>
         <view class="sub-metric">
          æœ¬æœˆç¡®æ”¶: Â¥{{stats.month_revenue_fmt || '0'}}
        </view>
      </view>
    </view>

    <!-- 2. è¥æ”¶è¶‹åŠ¿å›¾ (Canvas) -->
    <view class="chart-section">
      <view class="chart-title">è¿‘6ä¸ªæœˆè¥æ”¶è¶‹åŠ¿</view>
      <canvas type="2d" id="financeTrendChart" class="trend-canvas"></canvas>
    </view>
  </view>

  <!-- 3. åŸºåœ°è´¡çŒ®æ¦œ -->
  <view class="ranking-section">
    <view class="section-title">åŸºåœ°è´¡çŒ®æ¦œ Top 5</view>
    <view class="ranking-list">
      <block wx:if="{{stats.base_rankings && stats.base_rankings.length > 0}}">
        <view class="ranking-item" wx:for="{{stats.base_rankings}}" wx:key="base_id">
          <view class="rank-index rank-{{index+1}}">{{index + 1}}</view>
          <view class="rank-info">
            <view class="rank-name">{{item.base_name}}</view>
            <view class="rank-bar-bg">
              <view class="rank-bar-fill" style="width: {{item.profit_margin * 100}}%"></view>
            </view>
          </view>
          <view class="rank-value">
            <view>Â¥{{item.total_income}}</view>
            <text class="rank-sub">åˆ©æ¶¦ç‡ {{item.profit_margin * 100}}%</text>
          </view>
        </view>
      </block>
      <view wx:else class="empty-text">æš‚æ— æ’åæ•°æ®</view>
    </view>
  </view>

  <!-- 4. å¾…åŠå®¡æ ¸æµ -->
  <view class="audit-section">
    <view class="audit-header">
      <view class="section-title">å¾…å®¡æ ¸æµæ°´</view>
      <view class="more-link" bindtap="onViewAllRecords">æŸ¥çœ‹å…¨éƒ¨ ></view>
    </view>
    
    <block wx:if="{{records.length > 0}}">
      <view class="record-card" wx:for="{{records}}" wx:key="id">
        <view class="card-left">
           <view class="record-type {{item.type}}">{{item.type === 'INCOME' ? 'æ”¶' : 'æ”¯'}}</view>
           <view class="record-detail">
             <view class="payer">{{item.payer_name}}</view>
             <view class="time">{{item.created_at}}</view>
           </view>
        </view>
        <view class="card-right">
           <text class="amount {{item.type}}">{{item.type === 'INCOME' ? '+' : '-'}}{{item.amount_cents / 100}}</text>
           <button class="btn-verify" size="mini" catchtap="onVerify" data-id="{{item.id}}" wx:if="{{item.status === 'PENDING'}}">å®¡æ ¸</button>
           <text class="status-text" wx:else>{{item.status}}</text>
        </view>
      </view>
    </block>
    <view wx:else class="empty-state-card">
      <text>ğŸ‰ æ‰€æœ‰æµæ°´å·²å¤„ç†å®Œæ¯•</text>
    </view>
  </view>

</view>
